<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Purchase Course</title>
    <!-- Include jQuery -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <!-- Include CSS for select2 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/css/select2.min.css">
    <!-- Include CSS for intl-tel-input -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.8/css/intlTelInput.min.css">

    <style>
        body {
            background: linear-gradient(to right, #1e3c72, #2a5298);
            font-family: 'Arial', sans-serif;
            padding: 40px;
            color: white;
            text-align: center;
        }

        .tabs {
            display: flex;
            justify-content: center;
            margin-bottom: 20px;
        }

        .tab {
            margin: 0 20px;
            padding: 10px 20px;
            cursor: pointer;
            background-color: #333;
            color: white;
            border-radius: 5px;
            font-size: 1.2em;
            transition: background-color 0.3s ease;
        }

        .tab:hover {
            background-color: #555;
        }

        .tab.active {
            background-color: #ffcc00;
            color: #333;
        }

        form {
            background: rgba(255, 255, 255, 0.9);
            padding: 30px;
            border-radius: 10px;
            width: 70%;
            margin: 0 auto;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            color: #333;
            text-align: left;
        }

        .form-field {
            display: flex;
            flex-direction: column;
            margin-bottom: 15px;
        }

        .form-row {
            display: flex;
            justify-content: space-between;
            gap: 10px;
        }

        .form-row > .form-field {
            flex: 1;
        }

        label {
            font-size: 1em;
            color: #333;
            margin-bottom: 5px;
        }

        input, select {
            width: 100%;
            padding: 10px;
            border-radius: 5px;
            border: 1px solid #ccc;
            background-color: #f9f9f9;
            color: #333;
        }

        input:focus, select:focus {
            border-color: #2a5298;
            outline: none;
        }

        .btn-submit {
            background-color: #ffcc00;
            padding: 10px 25px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1.2em;
            transition: all 0.3s ease;
            color: #333;
            margin-top: 10px;
            width: 100%;
        }

        .btn-submit:hover {
            background-color: #e6b800;
            transform: scale(1.1);
        }

        .validity-icon {
            margin-left: 8px;
            font-size: 1.3em;
        }

        .validity-icon.correct {
            color: green;
        }

        .validity-icon.incorrect {
            color: red;
        }

        .error-message {
            color: red;
            font-size: 0.9em;
            margin-top: 5px;
            height: 15px;
        }
    </style>
</head>
<body>
    <!-- Navigation Tabs -->
    <div class="tabs">
        <div class="tab" onclick="window.location.href='index.html'">Home</div>
        <div class="tab" onclick="window.location.href='course-registration.html'">Courses</div>
        <div class="tab" onclick="window.location.href='contact.html'">Contact</div>
        <div class="tab active" onclick="window.location.href='purchase.html'">Payment</div>
    </div>

    <!-- Contact Section -->
    <div id="contact" class="section active-section">
        <h1>Course Registration</h1>
        <form id="purchaseForm">
            <!-- Selected Course -->
            <div class="form-field">
                <label for="selectedCourse"><strong>Geselecteerde cursus:</strong></label>
                <input type="text" id="selectedCourse" name=selectedCourse readonly>
            </div>
            <div class="form-field">
                <label for="salutation">Aanhef:</label>
                <select id="salutation" required>
                    <option value="">Selecteer</option>
                    <option value="Dhr.">Dhr.</option>
                    <option value="Mw.">Mw.</option>
                </select>
            </div>

            <!-- Name Fields -->
            <div class="form-row">
                <div class="form-field">
                    <label for="firstName">Voornaam:</label>
                    <input type="text" id="firstName" placeholder="Voornaam" required>
                </div>
                <div class="form-field">
                    <label for="MiddleName">Tussenvoegsel:</label>
                    <input type="text" id="MiddleName" placeholder="Tussenvoegsel">
                </div>
                <div class="form-field">
                    <label for="lastName">Achternaam:</label>
                    <input type="text" id="lastName" placeholder="Achternaam" required>
                </div>
            </div>

            <!-- Email Fields -->
            <div class="form-row">
                <div class="form-field">
                    <label for="email">E-mail:</label>
                    <input type="email" id="email" placeholder="E-mail" required>
                    <span class="validity-icon" id="emailIcon"></span>
                </div>
                <div class="form-field">
                    <label for="confirmEmail">Bevestig E-mail:</label>
                    <input type="email" id="confirmEmail" placeholder="Bevestig E-mail" required>
                    <span class="validity-icon" id="emailMatchIcon"></span>
                </div>
            </div>

            <!-- Phone -->
            <div class="form-field">
                <label for="phone">Telefoonnummer:</label>
                <input type="tel" id="phone" placeholder="Telefoonnummer" required>
                <span class="validity-icon" id="phoneIcon"></span>
            </div>

            <!-- Address -->
            <div class="form-row">
                <div class="form-field">
                    <label for="postalCode">Postcode:</label>
                    <input type="text" id="postalCode" placeholder="Postcode" required>
                </div>
                <div class="form-field">
                    <label for="houseNumber">Huisnummer:</label>
                    <input type="text" id="houseNumber" placeholder="Huisnummer" required>
                </div>
            </div>
            <div class="form-field">
                <label for="address">Straatnaam:</label>
                <input type="text" id="address" placeholder="Straatnaam" required>
            </div>
            <div class="form-field">
                <label for="citySelect">Stad:</label>
                <select id="citySelect" required>
                    <option value="">Selecteer een stad</option>
                </select>
            </div>

            <!-- Payment Terms -->
            <div class="form-field">
                <label for="paymentTerms">Betaaltermijnen:</label>
                <select id="paymentTerms" required>
                    <option value="">Selecteer betaaltermijnen</option>
                    <option value="ineens">Ineens (One-time payment)</option>
                    <option value="2_months">2 maandtermijnen</option>
                </select>
            </div>

            <!-- IBAN -->
            <div class="form-field">
                <label for="iban-number">IBAN:</label>
                <input type="text" id="iban-number" placeholder="NL00 BANK 0000 0000 00" required>
                <span class="validity-icon" id="ibanIcon"></span>
            </div>

            <!-- Agreement Checkbox -->
            <div class="form-field">
                <input type="checkbox" id="agreeTerms" required>
                <label for="agreeTerms">Ik ga akkoord met de <a href="terms.html" target="_blank" style="color: #ffcc00;">algemene voorwaarden</a>.</label>
            </div>

            <button type="submit" class="btn-submit">Verzenden</button>
        </form>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/js/select2.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/libphonenumber-js/1.9.16/libphonenumber-js.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.8/js/intlTelInput.min.js"></script>
    <script>
        // Populate cities
        const cities = ["Amsterdam", "Rotterdam", "Den Haag", "Utrecht", "Eindhoven"];
        const citySelect = document.getElementById("citySelect");
        cities.forEach(city => {
            const option = document.createElement("option");
            option.value = city;
            option.textContent = city;
            citySelect.appendChild(option);
        });

         // Get the selected course from the URL
        const urlParams = new URLSearchParams(window.location.search);
        const courseName = urlParams.get("course") || "Geen cursus geselecteerd";

        document.addEventListener("DOMContentLoaded", function () {
            const urlParams = new URLSearchParams(window.location.search);
            const courseName = urlParams.get("course");

            if (!courseName) {
                // Redirect to course registration page if no course is selected
                alert("No course selected. Redirecting to course registration.");
                window.location.href = "course-registration.html";
                return; // Stop further script execution
            }

            // If course is valid, prefill the course name
            document.getElementById("selectedCourse").value = courseName;
        });
        // Prefill the read-only input field

        document.getElementById("selectedCourse").value = courseName;


        // Phone input
        const phoneInput = document.getElementById("phone");
        const phoneIcon = document.getElementById("phoneIcon");
        const iti = intlTelInput(phoneInput, {
            initialCountry: "nl",
            utilsScript: "https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.8/js/utils.js"
        });

        phoneInput.addEventListener("input", () => {
            phoneIcon.textContent = iti.isValidNumber() ? "✔" : "✖";
            phoneIcon.className = iti.isValidNumber() ? "validity-icon correct" : "validity-icon incorrect";
        });

        // Email validation
        const emailInput = document.getElementById("email");
        const confirmEmailInput = document.getElementById("confirmEmail");
        const emailIcon = document.getElementById("emailIcon");
        const emailMatchIcon = document.getElementById("emailMatchIcon");

        function isValidEmail(email) {
            const domainRegex = /^[^\s@]+@[^\s@]+\.[^\s@]{2,}$/;
            return domainRegex.test(email);
        }

        emailInput.addEventListener("input", () => {
            emailIcon.textContent = isValidEmail(emailInput.value) ? "✔" : "✖";
            emailIcon.className = isValidEmail(emailInput.value) ? "validity-icon correct" : "validity-icon incorrect";
        });

        confirmEmailInput.addEventListener("input", () => {
            emailMatchIcon.textContent = emailInput.value === confirmEmailInput.value ? "✔" : "✖";
            emailMatchIcon.className = emailInput.value === confirmEmailInput.value ? "validity-icon correct" : "validity-icon incorrect";
        });

        // IBAN validation
        const ibanInput = document.getElementById("iban-number");
        const ibanIcon = document.getElementById("ibanIcon");

        function isValidIBAN(iban) {
            const ibanRegex = /^NL\d{2}[A-Z]{4}\d{10}$/;
            return ibanRegex.test(iban.replace(/\s+/g, ""));
        }

        ibanInput.addEventListener("input", () => {
            let formattedIBAN = ibanInput.value.toUpperCase().replace(/[^A-Z0-9]/g, "").replace(/(.{4})/g, "$1 ").trim();
            ibanInput.value = formattedIBAN;
            ibanIcon.textContent = isValidIBAN(formattedIBAN) ? "✔" : "✖";
            ibanIcon.className = isValidIBAN(formattedIBAN) ? "validity-icon correct" : "validity-icon incorrect";
        });

        // Form submission
        document.getElementById("purchaseForm").addEventListener("submit", async function (e) {
            e.preventDefault();

            const formData = {
                course: document.getElementById("selectedCourse").value,
                salutation: document.getElementById("salutation").value,
                firstName: document.getElementById("firstName").value,
                middleName: document.getElementById("MiddleName").value,
                lastName: document.getElementById("lastName").value,
                email: emailInput.value,
                phone: iti.getNumber(),
                postalCode: document.getElementById("postalCode").value,
                houseNumber: document.getElementById("houseNumber").value,
                address: document.getElementById("address").value,
                city: citySelect.value,
                paymentTerms: document.getElementById("paymentTerms").value,
                iban: ibanInput.value
            };

            if (!iti.isValidNumber()) {
                alert("Please enter a valid phone number.");
                return;
            }

            if (!isValidEmail(emailInput.value)) {
                alert("Please enter a valid email address.");
                return;
            }

            if (emailInput.value !== confirmEmailInput.value) {
                alert("Email and confirm email do not match.");
                return;
            }

            if (!isValidIBAN(ibanInput.value)) {
                alert("Please enter a valid IBAN.");
                return;
            }


            sessionStorage.setItem("registrationData", JSON.stringify(formData));
            try {
                const response = await fetch("http://127.0.0.1:8080/submit-form", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify(formData)
                    });

                    if (response.ok) {
                        try {
                            const result = await response.json();
                            alert(result.message);
                        } catch (parseError) {
                            console.error("Error parsing JSON:", parseError);
                            alert("Server returned an invalid response.");
                        }
                    } else {
                        const error = await response.text();
                        console.error("Server error:", error);
                        alert(`Error: ${error}`);
                    }
                } catch (err) {
                    console.error("Error submitting form:", err);
                    alert("An error occurred while submitting the form. Please try again.");
                }
            });
    </script>
</body>
</html>
